var ejs         = require('ejs'),
  loaderUtils = require('loader-utils'),
  path        = require('path');

module.exports = function(source) {
  this.cacheable && this.cacheable();

  /** Get query options **/
  var options = loaderUtils.parseQuery(this.query);

  /** Returns standalone compiled function */
  options.client = true;

  /** Get filename and set it **/
  options.filename = path.relative(process.cwd(), this.resourcePath);

  /** Template function **/
  var template = ejs.compile(source, options);

  return 'module.exports = ' + template;
};
